@page
@model api_flms_service.Pages.Books.ManagerRenewedBookModel

<h2>Your Borrowed Books</h2>

<table id="borrowedBooksTable">
    <thead>
        <tr>
            <th>Book Name</th>
            <th>Due Date</th>
            <th>Image</th> <!-- Cột để hiển thị ảnh -->
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <!-- Data will be populated here by JavaScript -->
    </tbody>
</table>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Gọi API để lấy danh sách sách mượn
        fetch('/api/v0/books/borrowed', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json(); // Chuyển phản hồi thành JSON
        })
        .then(data => {
            const tableBody = document.querySelector('#borrowedBooksTable tbody');
            data.forEach(book => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${book.bookName}</td>
                    <td>${new Date(book.borrowedUntil).toLocaleDateString()}</td>
                    <td>
                        <!-- Hiển thị ảnh nếu có -->
                        ${book.imageUrls ? `<img src="${book.imageUrls.split(',')[0]}" alt="Book Image" style="width: 50px; height: 75px; object-fit: cover;" />` : 'No image'}
                    </td>
                    <td><button onclick="renewBook(${book.bookId})">Renew</button></td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error:', error));
    });

    // Hàm gia hạn sách
    function renewBook(bookId) {
        fetch('/api/v0/books/renew', {
            method: 'POST',
            body: JSON.stringify({ BookId: bookId }), // Gửi bookId lên API
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            alert('Book renewed successfully. New due date: ' + data.newDueDate);
            location.reload(); // Tải lại trang sau khi gia hạn
        })
        .catch(error => {
            alert('Error renewing book: ' + error);
        });
    }
</script>
