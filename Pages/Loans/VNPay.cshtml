@page "{id:int?}"
@model api_flms_service.Pages.Loans.VNPayModel

@{
    ViewData["Title"] = "VNPay Payment";
}

<h2>@ViewData["Title"]</h2>

@if (Model.Loan != null && Model.Book != null)
{
    <div>
        <h3>Book Title: @Model.Book.Title</h3>
        <p><strong>Author:</strong> @Model.Book.Author?.Name</p>
        <p><strong>ISBN:</strong> @Model.Book.ISBN</p>

        <h4>Overdue Fee Calculation</h4>
        @if (Model.OverdueFee > 0)
        {
            <p><strong>Overdue Fee:</strong> @Model.OverdueFee.ToString("C") VNĐ</p>
        }
        else
        {
            <p>The book is not overdue.</p>
        }

        <form id="paymentForm">
            <button type="submit">Thanh toán qua VNPAY</button>
        </form>
    </div>
}
else
{
    <p>Loan details not found.</p>
}

<script>
    async function getClientIp() {
        try {
            const response = await fetch('https://api64.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error('Error fetching IP address:', error);
            return '8.8.8.8'; // Default fallback IP
        }
    }

    document.getElementById("paymentForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        const clientIp = await getClientIp(); // Lấy IP đúng cách
        const urlParams = new URLSearchParams(window.location.search);
        const loanId = urlParams.get('id');

        const response = await fetch(`/api/v0/Loan/pay?loanId=${loanId}&clientip=${clientIp}`, {
            method: "POST"
        });

        const data = await response.json();
        if (data.url) {
            window.location.href = data.url; // Điều hướng đến trang thanh toán
        } else {
            alert("Lỗi khi tạo thanh toán!");
        }
    });
</script>
